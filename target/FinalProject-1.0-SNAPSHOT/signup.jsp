<%--
  Created by IntelliJ IDEA.
  User: bree2
  Date: 4/27/22
  Time: 8:30 PM
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<%
    java.sql.Connection conn;                 // Connection: A connection with a specific database.
    java.sql.ResultSet rs, rs1;                   // ResultSet: A table of data representing a database result set, which is usually generated by executing a statement that queries the database.
    java.sql.Statement st,st1, st2, st3;               // Statement: The object used for executing a static SQL statement and returning the results it produces.
    // mysql database to work with your project. Go to,
    // Your project -> right click -> properties -> Libraries -> Compiler tab -> Add library -> select "MySQL JDBC Driver" library -> Ok
    Class.forName("com.mysql.jdbc.Driver"); //to connect mysql database
    conn = java.sql.DriverManager.getConnection("jdbc:mysql://localhost/businessdirectory", "root", "BreeF#11");  //connection with database.. demo: db name, username:root, password: " "
    st = conn.createStatement();
    st1 = conn.createStatement();
    st2 = conn.createStatement();
    st3 = conn.createStatement();

    //get parameter value by using the 'name' of the field
    String businessName = request.getParameter("business-name");
    String ownerFirstName = request.getParameter("firstname");
    String ownerLastName = request.getParameter("lastname");
    String desc = request.getParameter("description");
    String phone = request.getParameter("phone");
    String website = request.getParameter("website");
    String username = request.getParameter("username");
    String password = request.getParameter("password");

    String qr = "SELECT username FROM users WHERE username = '"+username+"'";    //query to select if the username already exists or not
    rs = st.executeQuery(qr);
    if(rs.next())
    {
        // passing variable "a" with URL
        // lets say "a" is for "user already exists"
        response.sendRedirect("application.jsp?a");                                    // if username found in database, redirect user to index.jsp with some error
    }
    else
    {
        String userInsertion = "INSERT INTO users (fname, lname, username, password, is_admin) VALUES " +
                "('"+ownerFirstName+"', '"+ownerLastName+"', '"+username+"', '"+password+"', 0)";
        st1.executeUpdate(userInsertion);

        String getUserId = "SELECT user_id FROM users WHERE username = '"+username+"'";
        rs1 = st3.executeQuery(getUserId);
        rs1.next();
        int newUserId = rs1.getInt("user_id");
        String sql = "INSERT INTO businesses (name, user_id, description, phone, website, is_pending) values" +
                "('"+businessName+"', '"+newUserId+"', '"+desc+"', '"+phone+"', '"+website+"', 1)";
        st2.executeUpdate(sql);

        //create session: to keep track of user
        // we will check on home.jsp if this session was created or not.
        // if not user must login to go to home.jsp
        session.setAttribute("uname", username);          //session created... name: 'uname' and value: 'username' of the user
        response.sendRedirect("index.jsp");
    }
%>